
# نقشه راه پیاده‌سازی اشتراک (۷ روز رایگان)

این سند به عنوان یک راهنمای کامل برای افزودن قابلیت اشتراک به برنامه، جهت تایید در کافه‌بازار و ارائه به کاربران تهیه شده است. مدل اشتراک به صورت **۷ روز استفاده آزمایشی (Trial)** و سپس نیاز به **خرید اشتراک ماهانه** خواهد بود.

---

## فاز ۱: طراحی رابط و تجربه کاربری (UI/UX)

هدف این فاز، ایجاد تمام عناصر ظاهری مورد نیاز برای معرفی و مدیریت اشتراک به کاربر است.

### ۱.۱. دکمه اشتراک در `AppBar`

یک دکمه یا آیکون برای دسترسی سریع به صفحه اشتراک در نوار بالای برنامه (AppBar) قرار می‌گیرد.

- **محل قرارگیری:** این دکمه باید هم در صفحه ورود (Login) و هم در صفحات داخلی برنامه (بعد از ورود کاربر) نمایش داده شود.
- **طراحی:**
    - **قبل از ورود:** یک دکمه متنی با عنوان «**اشتراک**» یا «**Subscription**».
    - **بعد از ورود:** برای هماهنگی با سایر آیکون‌ها، می‌توان از یک آیکون مثل `Icon(Icons.workspace_premium_outlined)` یا `Icon(Icons.star_border)` استفاده کرد.
    - **جذابیت بصری:** در صورتی که کاربر اشتراک نداشته باشد، می‌توان این آیکون را با یک انیمیشن ظریف یا رنگ متمایز (مثلاً طلایی) نمایش داد تا توجه کاربر را جلب کند.
- **وظیفه:** با کلیک بر روی این دکمه، کاربر به `SubscriptionPage` هدایت می‌شود.

### ۱.۲. صفحه مدیریت اشتراک (`SubscriptionPage`)

این صفحه مرکز مدیریت اشتراک کاربر است و باید اطلاعات شفاف و کافی را در اختیار او قرار دهد.

- **ساختار صفحه:**
    1.  **بخش وضعیت فعلی (Current Status):**
        - یک کارت (Card) در بالای صفحه که وضعیت اشتراک کاربر را با طراحی واضح نمایش می‌دهد.
        - **حالت‌های مختلف:**
            - **کاربر جدید:** «شما می‌توانید تا ۷ روز از تمام امکانات برنامه به صورت رایگان استفاده کنید.»
            - **دوره آزمایشی فعال:** «**دوره آزمایشی فعال است.** ۷ روز از اشتراک رایگان شما باقی مانده است.» (به صورت روزشمار)
            - **اشتراک فعال:** «**اشتراک شما فعال است.** اعتبار تا تاریخ: [تاریخ انقضا]»
            - **اشتراک منقضی شده:** «اعتبار اشتراک شما به پایان رسیده است. برای دسترسی به امکانات، اشتراک خود را تمدید کنید.»
    2.  **بخش طرح اشتراک (Subscription Plan):**
        - یک کارت دیگر که جزئیات طرح اشتراک را نمایش می‌دهد.
        - **محتوا:**
            - عنوان: «**اشتراک ماهانه**»
            - قیمت: «[قیمت] تومان» (قیمت از کافه‌بازار دریافت خواهد شد).
            - توضیحات: لیستی از قابلیت‌هایی که با خرید اشتراک فعال می‌شوند.
    3.  **دکمه فراخوان (Call to Action - CTA):**
        - دکمه اصلی صفحه که بسته به وضعیت کاربر، تغییر می‌کند:
            - **کاربر جدید:** «**فعال‌سازی ৭ روز رایگان**»
            - **دوره آزمایشی تمام شده:** «**خرید اشتراک ماهانه**»
            - **اشتراک منقضی شده:** «**تمدید اشتراک**»

- **بومی‌سازی (Localization):** تمام رشته‌های متنی (Strings) استفاده شده در این صفحه باید به دو زبان فارسی و انگلیسی در فایل‌های `app_fa.arb` و `app_en.arb` تعریف شوند.

---

## فاز ۲: پیاده‌سازی منطق برنامه (Logic)

در این فاز، منطق مربوط به ارتباط با کافه‌بازار، مدیریت وضعیت اشتراک و ذخیره‌سازی اطلاعات پیاده‌سازی می‌شود.

### ۲.۱. مدیریت وضعیت (State Management)

برای اینکه تمام بخش‌های برنامه (مثل دکمه AppBar و محدودیت دسترسی‌ها) از وضعیت اشتراک کاربر مطلع باشند، از یک راه‌حل مدیریت وضعیت متمرکز (مانند `Provider` یا `Bloc`) استفاده می‌کنیم.

- یک `SubscriptionProvider` (یا مشابه آن) ایجاد می‌شود که اطلاعات زیر را نگهداری می‌کند:
    - `isSubscribed`: (true/false) آیا کاربر اشتراک فعال دارد؟
    - `isTrialPeriod`: (true/false) آیا در دوره آزمایشی است؟
    - `trialEndDate`: تاریخ پایان دوره آزمایشی.
    - `subscriptionEndDate`: تاریخ پایان اشتراک پولی.
- این Provider در ابتدای برنامه (`main.dart`) مقداردهی اولیه می‌شود.

### ۲.۲. یکپارچه‌سازی با Poolakey

پکیج `flutter_poolakey` ابزار اصلی ما برای تمام عملیات‌های پرداخت خواهد بود.

1.  **راه‌اندازی (Initialization):** در هنگام شروع برنامه، Poolakey را با کلید RSA که از پنل توسعه‌دهندگان بازار دریافت کرده‌اید، راه‌اندازی می‌کنیم.
2.  **دریافت اطلاعات محصول:** قبل از نمایش `SubscriptionPage`، اطلاعات محصول (طرح اشتراک ماهانه) را با استفاده از `poolakey.getSubscriptionProducts()` از بازار دریافت می‌کنیم تا قیمت به‌روز را نمایش دهیم.
3.  **شروع فرآیند خرید/اشتراک:**
    - وقتی کاربر روی دکمه CTA کلیک می‌کند:
        - اگر دوره آزمایشی قبلاً استفاده نشده، فرآیند را با `trial: true` شروع می‌کنیم.
        - در غیر این صورت، تابع `poolakey.subscribe()` را با `SKU` محصول فراخوانی می‌کنیم.
4.  **پردازش نتیجه پرداخت:**
    - با استفاده از `poolakey.purchaseStream` به نتیجه تراکنش گوش می‌دهیم.
    - **در صورت موفقیت:**
        - اطلاعات خرید را از `PurchaseInfo` استخراج می‌کنیم.
        - با فراخوانی `poolakey.consumePurchase()` خرید را تایید و نهایی می‌کنیم (برای محصولات اشتراکی الزامی است).
        - وضعیت اشتراک را در `SubscriptionProvider` و حافظه دائمی دستگاه به‌روز می‌کنیم.
    - **در صورت شکست یا انصراف:** پیام مناسب به کاربر نمایش داده می‌شود.

### ۲.۳. ذخیره‌سازی دائمی وضعیت اشتراک

برای اینکه با بسته و باز شدن برنامه، وضعیت اشتراک کاربر حفظ شود، از `flutter_secure_storage` استفاده می‌کنیم.

- **اطلاعات ذخیره‌سازی:**
    - `purchaseToken`: توکن خرید که از بازار دریافت می‌شود (برای بررسی‌های آتی).
    - `subscriptionEndDate`: تاریخ انقضای اشتراک.
- در هر بار اجرای برنامه، این مقادیر را خوانده و `SubscriptionProvider` را با آن مقداردهی می‌کنیم.

---

## فاز ۳: محدودسازی دسترسی‌ها (Feature Gating)

باید دسترسی به قابلیت‌های پولی برنامه را برای کاربرانی که اشتراک ندارند (و دوره آزمایشی آن‌ها تمام شده) محدود کنیم.

- **روش پیاده‌سازی:**
    - یک **تابع کمکی (Helper Function)** یا **میکسین (Mixin)** به نام `hasActiveSubscription()` ایجاد می‌کنیم که وضعیت را از `SubscriptionProvider` می‌خواند.
    - این تابع بررسی می‌کند که آیا `isSubscribed` برابر `true` است یا تاریخ فعلی قبل از `subscriptionEndDate` (یا `trialEndDate`) است.
    - قبل از ورود به هر صفحه یا استفاده از هر قابلیت پولی، این تابع را فراخوانی می‌کنیم.
    - در صورت عدم دسترسی، کاربر را به `SubscriptionPage` هدایت کرده یا یک دیالوگ نمایش می‌دهیم.

---

## فاز ۴: تست و ارسال به بازار

1.  **تست کامل:**
    - **سناریوی کاربر جدید:** فعال‌سازی دوره آزمایشی، بررسی دسترسی‌ها و مشاهده شمارش معکوس.
    - **سناریوی خرید:** خرید اشتراک پس از پایان دوره آزمایشی.
    - **سناریوی انقضا:** شبیه‌سازی تاریخ انقضا و بررسی محدود شدن دسترسی‌ها.
    - **تست در حالت‌های مختلف:** آفلاین، انصراف از پرداخت و ... .
2.  **ارسال برای کافه‌بازار:**
    - پس از اطمینان از عملکرد صحیح، نسخه جدید را Build می‌گیریم.
    - در پنل توسعه‌دهندگان بازار، هنگام ثبت نسخه جدید، در بخش «توضیحات برای بازبین»، به صورت واضح توضیح می‌دهیم:
        > "با سلام، قابلیت پرداخت درون‌برنامه‌ای مطابق قوانین بازار در این نسخه پیاده‌سازی شده است. کاربر می‌تواند از طریق دکمه 'اشتراک' در نوار بالای برنامه، وارد صفحه اشتراک شده و پس از ۷ روز دوره آزمایشی رایگان، اشتراک ماهانه را خریداری نماید."
